# Django

Personal notes about the Django Web Framework.

## Resources

- [Official Tutorials](https://docs.djangoproject.com/en/5.1/intro/tutorial01/)

## Project structure

- `settings.py`: Settings/configuration for the Django project.
- `urls.py`: URL declarations for the project.
- `asgi.py`: Entry point for ASGI-compatible web servers.
- `wsgi.py`: Entry point for WSGI-compatible web servers.
- The `manage.py` python script is a CLI utility to interact with the project
in various ways.

___Note___: A project is a collection of configuration and apps for a
particular website. An app can be in multiple projects.

## Commands

start a Django project:

```bash
django-admin startproject mysite
```

start the development server - running on port 8000 by default:

```bash
python manage.py runserver
```

___Note___: The development server automatically reloads Python
code for each request as needed. No need to restart the server for
code changes to take effects. Some actions like adding files don't
trigger a restart so one needs to restart it in theses cases.

run the db migrations:

```bash
python manage.py migrate
```

generate the migration files of the app named `myapp`:

```bash
python manage.py makemigrations myapp
```

create an app:

```bash
python manage.py startapp myapp
```

below is the created directory structure for housing the app:

```txt
myapp/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

open the python shell to interact with the Django project programmatically:

```bash
python manage.py shell
```

check for any problem in the project:

```bash
python manage.py check
```

create an admin user:

```bash
python manage.py createsuperuser
```

## Models

__Note:__ A model is the single, definitive source of information about your
data. It contains the essential fields and behaviors of the data you are
storing with Django. Migrations are entirely derived from the models files.

Each model is represented by a class that subclasses `django.db.models.Model`.
Each model has a number of class variables, each of which represents a db field
in the model.
Each field is represented by an instance of a `Field` class (`CharField`,
`IntegerField`, `DateTimeField`, etc).
The name of each `Field` instance, is the field's name, that is used by the
database as a column name.
An optional first argument (`verbose_name`) can be used as a human readable
name.
Relationships between models are done through `ForeignKey` and
`ManyToManyField`.

Django is automatically able to create a db schema, create a python
database-access API for accessing the models - CRUD operations in the admin.

### Migrations

Some helper commands are available to manage the underlying db migrations.
Generate a migration file for the application `myapp`:

```bash
python manage.py makemigrations myapp
```

Display the generated SQL from the migration file `myapp/0001_*` - it does not
run the migration on the database, it only prints to stdout:

```bash
python manage.py sqlmigrate myapp 0001
```

__Notes__:

- Table names are automatically generated by combining the name of the app and
the lowercase name of the model.
- Primary keys are added automatically.
- Django appends `_id` to the foreign key field name.

Run the migrations that have not been applied yet:

```bash
python manage.py migrate
```

### database API

Open the Python shell to interact with the models:

```bash
python manage.py shell
```

[Documentation](https://docs.djangoproject.com/en/5.1/topics/db/queries/) of the Database API.

#### Lookup

One can perform primary key lookups with the following code:

```python
Model.object.get(pk=1)
```

Get the query set of objects (`Bar` class) that are in a 1-N relationship with
it (`ForeignKey`):

```python
m = Model.object.get(pk=1)
m.bar_set.count() # Return the count of the associated Bars with m
m.bar_set.all()   # Return the query set
```

More documentation [here](https://docs.djangoproject.com/en/5.1/topics/db/queries/#field-lookups-intro).

#### Relations

Documentation [here](https://docs.djangoproject.com/en/5.1/ref/models/relations/).

#### Create

```python
q.choice_set.create(choice_text="Not much", votes=0)
q.choice_set.create(choice_text="The sky", votes=0)
c = q.choice_set.create(choice_text="Just hacking again", votes=0)
```

#### Filtering

The API automatically follows relationships as far as needed.
Double underscores to separate relationships.

The available methods for filtering are:

- `filter`
- `exclude`
- `get`

```python
Choice.objects.filter(question__pub_date__year=2024)
```

```python
q.choice_set.filter(choice_text__startswith="Not")
```

All the field lookup types are documented
[here](https://docs.djangoproject.com/en/5.1/ref/models/querysets/#field-lookups).

Some examples are:

exact, iexact, contains, icontains, in, gt, gte, lt, lte,
startswith, istartswith, endswith, iendswith, range, date, year, iso_year,
month, day, week, week_day, iso_week_day, time, hour, minute, second, isnull,
regex, iregex.

#### SQL

To get a peek at the queryset generated SQL one can use the following function:

```python
qs = Model.objects.filter(...)
str(qs.query)
```

## Admin

The admin panel is available at `localhost:8000/admin/`.

Models need to be registered in their associated apps:

```python
from django.contrib import admin

admin.site.register(Model)
```

Forms are automatically generated from the `Model` fields.

## Views

A view is a type of web page that generally serves a specific function and has
a specific template.
In Django, web pages and other content are delivered by views. A view is
represented by a python function. URLs are matched to the requested views.

### Generic Views

Documentation on generic views [here](https://docs.djangoproject.com/en/5.1/topics/class-based-views/).

`ListView` and `DetailView` generic views abstract the concept of displaying a
list of objects and displaying a detail page for a particular type of object.

A generic view needs to know what model it will be acting upon. It is provided
either with the `model` attribute or the `get_queryset()` method.
By default, the template used is `myapp/model_name_detail.html` or
`myapp/model_name_index.html`. Specify the `template_name` attribute to
override it.

The default `context_object_name` is `model_name_list`. To override it, specify
a value for `context_object_name`.

```python
from django.views import generic

class IndexView(generic.ListView):
    template_name = "polls/index.html"
    context_object_name = "latest_question_list"

    def get_queryset(self):
        """Returns the last five published questions."""
        return Question.objects.order_by("-pub_date")[:5]
```

### Templates

Jinja templates can be used for server side rendering.
Example of template filename: `myapp/templates/myapp/mytemplate.html`

Documentation [here](https://docs.djangoproject.com/en/5.1/topics/templates/).

A template is rendered with a `context`. Rendering remplaces variables with
their values, which are looked up in the context, and executes tags. Everything
else is output as is.

#### Variables

Variables are surrounded by `{{` and `}}`.

```jinja
My first name is {{ first_name }}. My last name is {{ last_name }}.
```

Dictionnary lookup, attribute lookup and list-index lookups are implemented
with a dot notation.

```jinja
{{ my_dict.key }}
{{ my_object.attribute }}
{{ my_list.0 }}
```

If a variable resolves to a callable, the template system calls it with no
argument and use its result instead of the callable.

#### Tags

Tags provide arbitrary logic in the rendering process: output content, serve as
a control structure, grab content from a database, enable access to other
template tags, etc.

```jinja
{% csrf_token %}
```

```jinja
{% if user.is_authenticated %}Hello, {{ user.username }}.{% endif %}
```

Reference of built-in tags [here](https://docs.djangoproject.com/en/5.1/ref/templates/builtins/#ref-templates-builtins-tags).
It is also possible to [write custom tags](https://docs.djangoproject.com/en/5.1/howto/custom-template-tags/#howto-writing-custom-template-tags).

##### Common tags

- `url`: it uses the `name` parameter from the `path` call.

```jinja
<li><a href="{% url 'detail' question.id %}">{{ question.question_text }}</a></li>
```

It is common to namespace URLs by providing the `app_name` variable in `myapp/urls.py`.
Then it becomes possible to namespace the URL like so:

```jinja
<li><a href="{% url 'myapp:detail' question.id %}">{{ question.question_text }}</a></li>
```

__Note__: It removes the hardcoded link and use the urlpatterns provided in the
configuration.

- `for`: for loop to iterate over an iterable

one can access the for loop index using the following variable: ```{{ forloop.counter }}```

#### Filters

Filters transform the values of variables and tag arguments.

```jinja
{{ django|title }}
```

Some filters can take an argument:

```jinja
{{ my_date|date:"Y-m-d" }}
```

Reference of built-in filters [here](https://docs.djangoproject.com/en/5.1/ref/templates/builtins/#ref-templates-builtins-filters).
It is also possible to [write custom filters](https://docs.djangoproject.com/en/5.1/howto/custom-template-tags/#howto-writing-custom-template-filters).

#### Comments

single line comment

```jinja
{# this won't be rendered #}
```

multi line comment

```jinja
{% comment "Optional note" %}
  <p>Commented out text.</p>
{% endcomment %}
```

### Shorcuts

- `django.shortcut.render`:

```python
from django.shorcuts import render

def index(request):
    ...
    context = { "x": 42, "y": "hello world" }
    return render(request=request, template_name="myapp/mytemplate.html", context=context)
```

- `get_object_or_404()`:

```python
from django.shorcuts import get_object_or_404

def detail(request, id):
    obj = get_object_or_404(Model, pk=id)
    return render(...)
```

__Note__: `get_list_or_404` works similarly except using `filter` instead of
`get`.

## request

Request and response objects [documentation](https://docs.djangoproject.com/en/5.1/ref/request-response/).

### POST

`request.POST` is a dictionnary-like object that lets one access submitted data
by key name. Values are always strings.
`KeyError` is raised if the key is not present in the POST dictionnary like
object.

## Tests

Documentation for testing in Django [here](https://docs.djangoproject.com/en/5.1/topics/testing/):

- [Writing tests](https://docs.djangoproject.com/en/5.1/topics/testing/overview/)
- [Running tests](https://docs.djangoproject.com/en/5.1/topics/testing/overview/#running-tests)
- [Testing tools](https://docs.djangoproject.com/en/5.1/topics/testing/tools/)

run tests for the app `myapp`:

```bash
python manage.py test myapp
```

run all the tests of the django project:

```bash
python manage.py test
```

run all test tests in the `animals.tests` module:

```bash
python manage.py test animals.tests
```

run just one test method:

```bash
python manage.py test animals.test.AnimalTestCase.test_animals_can_speak
```

run tests for files that match a specific pattern:

```bash
./manage.py test --pattern="tests_*.py"
```

Django provides a test `client` to simulate a user interacting with the code at
the view level. It can be used in test files and also in the `shell`.

```python
from django.test import Client
client = Client()

client.get("/polls/results")
```

```python
from django.test.utils import setup_test_environment
```

__Note__: `setup_test_environment` installs a template renderer which allows
one to examine additional attributes on responses. Especially
`response.context` which is the context dictionnary used in the template.
