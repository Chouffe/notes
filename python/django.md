# Django

Personal notes about the Django Web Framework.

## Resources

- [Official Tutorials](https://docs.djangoproject.com/en/5.1/intro/tutorial01/)

## Project structure

- `settings.py`: Settings/configuration for the Django project.
- `urls.py`: URL declarations for the project.
- `asgi.py`: Entry point for ASGI-compatible web servers.
- `wsgi.py`: Entry point for WSGI-compatible web servers.
- The `manage.py` python script is a CLI utility to interact with the project
in various ways.

___Note___: A project is a collection of configuration and apps for a
particular website. An app can be in multiple projects.

## Commands

start a Django project:

```bash
django-admin startproject mysite
```

start the development server - running on port 8000 by default:

```bash
python manage.py runserver
```

___Note___: The development server automatically reloads Python
code for each request as needed. No need to restart the server for
code changes to take effects. Some actions like adding files don't
trigger a restart so one needs to restart it in theses cases.

run the db migrations:

```bash
python manage.py migrate
```

generate the migration files of the app named `myapp`:

```bash
python manage.py makemigrations myapp
```

create an app:

```bash
python manage.py startapp myapp
```

below is the created directory structure for housing the app:

```txt
myapp/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

open the python shell to interact with the Django project programmatically:

```bash
python manage.py shell
```

check for any problem in the project:

```bash
python manage.py check
```

create an admin user:

```bash
python manage.py createsuperuser
```

## Models

__Note:__ A model is the single, definitive source of information about your
data. It contains the essential fields and behaviors of the data you are
storing with Django. Migrations are entirely derived from the models files.

Each model is represented by a class that subclasses `django.db.models.Model`.
Each model has a number of class variables, each of which represents a db field
in the model.
Each field is represented by an instance of a `Field` class (`CharField`,
`IntegerField`, `DateTimeField`, etc).
The name of each `Field` instance, is the field's name, that is used by the
database as a column name.
An optional first argument (`verbose_name`) can be used as a human readable
name.
Relationships between models are done through `ForeignKey` and
`ManyToManyField`.

Django is automatically able to create a db schema, create a python
database-access API for accessing the models - CRUD operations in the admin.

### Migrations

Some helper commands are available to manage the underlying db migrations.
Generate a migration file for the application `myapp`:

```bash
python manage.py makemigrations myapp
```

Display the generated SQL from the migration file `myapp/0001_*` - it does not
run the migration on the database, it only prints to stdout:

```bash
python manage.py sqlmigrate myapp 0001
```

__Notes__:

- Table names are automatically generated by combining the name of the app and
the lowercase name of the model.
- Primary keys are added automatically.
- Django appends `_id` to the foreign key field name.

Run the migrations that have not been applied yet:

```bash
python manage.py migrate
```

### database API

Open the Python shell to interact with the models:

```bash
python manage.py shell
```

[Documentation](https://docs.djangoproject.com/en/5.1/topics/db/queries/) of the Database API.

#### Lookup

One can perform primary key lookups with the following code:

```python
Model.object.get(pk=1)
```

Get the query set of objects (`Bar` class) that are in a 1-N relationship with
it (`ForeignKey`):

```python
m = Model.object.get(pk=1)
m.bar_set.count() # Return the count of the associated Bars with m
m.bar_set.all()   # Return the query set
```

More documentation [here](https://docs.djangoproject.com/en/5.1/topics/db/queries/#field-lookups-intro).

#### Relations

Documentation [here](https://docs.djangoproject.com/en/5.1/ref/models/relations/).

#### Create

```python
q.choice_set.create(choice_text="Not much", votes=0)
q.choice_set.create(choice_text="The sky", votes=0)
c = q.choice_set.create(choice_text="Just hacking again", votes=0)
```

#### Filtering

The API automatically follows relationships as far as needed.
Double underscores to separate relationships.

The available methods for filtering are:

- `filter`
- `exclude`
- `get`

```python
Choice.objects.filter(question__pub_date__year=2024)
```

```python
q.choice_set.filter(choice_text__startswith="Not")
```

All the field lookup types are documented
[here](https://docs.djangoproject.com/en/5.1/ref/models/querysets/#field-lookups).

Some examples are:

exact, iexact, contains, icontains, in, gt, gte, lt, lte,
startswith, istartswith, endswith, iendswith, range, date, year, iso_year,
month, day, week, week_day, iso_week_day, time, hour, minute, second, isnull,
regex, iregex.

#### SQL

To get a peek at the queryset generated SQL one can use the following function:

```python
qs = Model.objects.filter(...)
str(qs.query)
```

## Admin

The admin panel is available at `localhost:8000/admin/`.
