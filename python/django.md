# Django

Personal notes about the Django Web Framework.

## Project structure

- `settings.py`: Settings/configuration for the Django project.
- `urls.py`: URL declarations for the project.
- `asgi.py`: Entry point for ASGI-compatible web servers.
- `wsgi.py`: Entry point for WSGI-compatible web servers.
- The `manage.py` python script is a CLI utility to interact with the project
in various ways.

___Note___: A project is a collection of configuration and apps for a
particular website. An app can be in multiple projects.

## Commands

start a Django project:

```bash
django-admin startproject mysite
```

start the development server - running on port 8000 by default:

```bash
python manage.py runserver
```

___Note___: The development server automatically reloads Python
code for each request as needed. No need to restart the server for
code changes to take effects. Some actions like adding files don't
trigger a restart so one needs to restart it in theses cases.

run the db migrations:

```bash
python manage.py migrate
```

generate the migration files of the app named `myapp`:

```bash
python manage.py makemigrations myapp
```

create an app:

```bash
python manage.py startapp myapp
```

below is the created directory structure for housing the app:

```txt
myapp/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

open the python shell to interact with the Django project programmatically:

```bash
python manage.py shell
```

check for any problem in the project:

```bash
python manage.py check
```

create an admin user:

```bash
python manage.py createsuperuser
```

## Admin Commands

Django provides a [number of admin commands](https://docs.djangoproject.com/en/5.0/ref/django-admin/#available-commands).

The most commons are:

- migrate
- startproject
- startapp
- dumpdata
- makemigrations

Users can also create their own admin commands by subtyping `BaseCommand`.

## Models

__Note:__ A model is the single, definitive source of information about your
data. It contains the essential fields and behaviors of the data you are
storing with Django. Migrations are entirely derived from the models files.

Each model is represented by a class that subclasses `django.db.models.Model`.
Each model has a number of class variables, each of which represents a db field
in the model.
Each field is represented by an instance of a `Field` class (`CharField`,
`IntegerField`, `DateTimeField`, etc).
The name of each `Field` instance, is the field's name, that is used by the
database as a column name.
An optional first argument (`verbose_name`) can be used as a human readable
name.
Relationships between models are done through `ForeignKey` and
`ManyToManyField`.

Django is automatically able to create a db schema, create a python
database-access API for accessing the models - CRUD operations in the admin.

### Migrations

Some helper commands are available to manage the underlying db migrations.
Generate a migration file for the application `myapp`:

```bash
python manage.py makemigrations myapp
```

Display the generated SQL from the migration file `myapp/0001_*` - it does not
run the migration on the database, it only prints to stdout:

```bash
python manage.py sqlmigrate myapp 0001
```

__Notes__:

- Table names are automatically generated by combining the name of the app and
the lowercase name of the model.
- Primary keys are added automatically.
- Django appends `_id` to the foreign key field name.

Run the migrations that have not been applied yet:

```bash
python manage.py migrate
```

### database API

Open the Python shell to interact with the models:

```bash
python manage.py shell
```

[Documentation](https://docs.djangoproject.com/en/5.1/topics/db/queries/) of the Database API.

#### Lookup

One can perform primary key lookups with the following code:

```python
Model.object.get(pk=1)
```

Get the query set of objects (`Bar` class) that are in a 1-N relationship with
it (`ForeignKey`):

```python
m = Model.object.get(pk=1)
m.bar_set.count() # Return the count of the associated Bars with m
m.bar_set.all()   # Return the query set
```

More documentation [here](https://docs.djangoproject.com/en/5.1/topics/db/queries/#field-lookups-intro).

#### Relations

Documentation [here](https://docs.djangoproject.com/en/5.1/ref/models/relations/).

#### Create

```python
q.choice_set.create(choice_text="Not much", votes=0)
q.choice_set.create(choice_text="The sky", votes=0)
c = q.choice_set.create(choice_text="Just hacking again", votes=0)
```

#### Filtering

The API automatically follows relationships as far as needed.
Double underscores to separate relationships.

The available methods for filtering are:

- `filter`
- `exclude`
- `get`

```python
Choice.objects.filter(question__pub_date__year=2024)
```

```python
q.choice_set.filter(choice_text__startswith="Not")
```

All the field lookup types are documented
[here](https://docs.djangoproject.com/en/5.1/ref/models/querysets/#field-lookups).

Some examples are:

exact, iexact, contains, icontains, in, gt, gte, lt, lte,
startswith, istartswith, endswith, iendswith, range, date, year, iso_year,
month, day, week, week_day, iso_week_day, time, hour, minute, second, isnull,
regex, iregex.

#### SQL

To get a peek at the queryset generated SQL one can use the following function:

```python
qs = Model.objects.filter(...)
str(qs.query)
```

## Admin

The admin panel is available at `localhost:8000/admin/`.

Models need to be registered in their associated apps:

```python
from django.contrib import admin

admin.site.register(Model)
```

Forms are automatically generated from the `Model` fields.

### Customizing admin forms

slight customization can happen by subclassing an `admin.ModelAdmin`:

```python
from django.contrib import admin

from .models import Question

class QuestionAdmin(admin.ModelAdmin):
    # Allows ordering the fields in the order desired for instance.
    # fields = ["pub_date", "question_text"]

    fieldsets = [
        (None, {"fields": ["question_text"]}),
        ("Date information", {"fields": ["pub_date"]}),
    ]

admin.site.register(Question, QuestionAdmin)
```

#### Adding related objects

It is possible (and often better) to allow the creation of related objects from
the same admin form. Using `admin.StackedInline` or `admin.TabularInline` makes
it possible.

```python
from .models import Choice, Question

class ChoiceInline(admin.StackedInline):
    model = Choice
    extra = 3


class QuestionAdmin(admin.ModelAdmin):
    fieldsets = ...
    inlines = [ChoiceInline]
```

### Change List

By default Django displays the `str()` of each object. But sometimes, it would
be more useful to display individual fields. Using the `list_display` admin
option lets one just do this. It is also possible to display the method calls.

```python
class QuestionAdmin(admin.ModelAdmin):
    ...
    list_display = ["question_text", "pub_date", "was_published_recently"]
```

It is also possible to override the default method str by decorating the model method:

```python
class Question(models.Model):

    ...
    @admin.display(
        boolean=True,
        ordering="pub_date",
        description="Published recently?",
    )
    def was_published_recently(self) -> bool:
        ...
```

### Filters

It is possible to add filters to the List View by specifying field attributes
in `list_filter`:

```python
class QuestionAdmin(admin.ModelAdmin):
    ...
    list_filter = ["pub_date"]
```

## Views

A view is a type of web page that generally serves a specific function and has
a specific template.
In Django, web pages and other content are delivered by views. A view is
represented by a python function. URLs are matched to the requested views.

### Generic Views

Documentation on generic views [here](https://docs.djangoproject.com/en/5.1/topics/class-based-views/).

`ListView` and `DetailView` generic views abstract the concept of displaying a
list of objects and displaying a detail page for a particular type of object.

A generic view needs to know what model it will be acting upon. It is provided
either with the `model` attribute or the `get_queryset()` method.
By default, the template used is `myapp/model_name_detail.html` or
`myapp/model_name_index.html`. Specify the `template_name` attribute to
override it.

The default `context_object_name` is `model_name_list`. To override it, specify
a value for `context_object_name`.

```python
from django.views import generic

class IndexView(generic.ListView):
    template_name = "polls/index.html"
    context_object_name = "latest_question_list"

    def get_queryset(self):
        """Returns the last five published questions."""
        return Question.objects.order_by("-pub_date")[:5]
```

### Templates

Jinja templates can be used for server side rendering.
Example of template filename: `myapp/templates/myapp/mytemplate.html`

Documentation [here](https://docs.djangoproject.com/en/5.1/topics/templates/).

A template is rendered with a `context`. Rendering remplaces variables with
their values, which are looked up in the context, and executes tags. Everything
else is output as is.

#### Variables

Variables are surrounded by `{{` and `}}`.

```jinja
My first name is {{ first_name }}. My last name is {{ last_name }}.
```

Dictionnary lookup, attribute lookup and list-index lookups are implemented
with a dot notation.

```jinja
{{ my_dict.key }}
{{ my_object.attribute }}
{{ my_list.0 }}
```

If a variable resolves to a callable, the template system calls it with no
argument and use its result instead of the callable.

#### Tags

Tags provide arbitrary logic in the rendering process: output content, serve as
a control structure, grab content from a database, enable access to other
template tags, etc.

```jinja
{% csrf_token %}
```

```jinja
{% if user.is_authenticated %}Hello, {{ user.username }}.{% endif %}
```

Reference of built-in tags [here](https://docs.djangoproject.com/en/5.1/ref/templates/builtins/#ref-templates-builtins-tags).
It is also possible to [write custom tags](https://docs.djangoproject.com/en/5.1/howto/custom-template-tags/#howto-writing-custom-template-tags).

##### Common tags

- `url`: it uses the `name` parameter from the `path` call.

```jinja
<li><a href="{% url 'detail' question.id %}">{{ question.question_text }}</a></li>
```

It is common to namespace URLs by providing the `app_name` variable in `myapp/urls.py`.
Then it becomes possible to namespace the URL like so:

```jinja
<li><a href="{% url 'myapp:detail' question.id %}">{{ question.question_text }}</a></li>
```

__Note__: It removes the hardcoded link and use the urlpatterns provided in the
configuration.

- `for`: for loop to iterate over an iterable

one can access the for loop index using the following variable: ```{{ forloop.counter }}```

#### Filters

Filters transform the values of variables and tag arguments.

```jinja
{{ django|title }}
```

Some filters can take an argument:

```jinja
{{ my_date|date:"Y-m-d" }}
```

Reference of built-in filters [here](https://docs.djangoproject.com/en/5.1/ref/templates/builtins/#ref-templates-builtins-filters).
It is also possible to [write custom filters](https://docs.djangoproject.com/en/5.1/howto/custom-template-tags/#howto-writing-custom-template-filters).

#### Comments

single line comment

```jinja
{# this won't be rendered #}
```

multi line comment

```jinja
{% comment "Optional note" %}
  <p>Commented out text.</p>
{% endcomment %}
```

### Shorcuts

- `django.shortcut.render`:

```python
from django.shorcuts import render

def index(request):
    ...
    context = { "x": 42, "y": "hello world" }
    return render(request=request, template_name="myapp/mytemplate.html", context=context)
```

- `get_object_or_404()`:

```python
from django.shorcuts import get_object_or_404

def detail(request, id):
    obj = get_object_or_404(Model, pk=id)
    return render(...)
```

__Note__: `get_list_or_404` works similarly except using `filter` instead of
`get`.

## request

Request and response objects [documentation](https://docs.djangoproject.com/en/5.1/ref/request-response/).

### POST

`request.POST` is a dictionnary-like object that lets one access submitted data
by key name. Values are always strings.
`KeyError` is raised if the key is not present in the POST dictionnary like
object.

## Tests

Documentation for testing in Django [here](https://docs.djangoproject.com/en/5.1/topics/testing/):

- [Writing tests](https://docs.djangoproject.com/en/5.1/topics/testing/overview/)
- [Running tests](https://docs.djangoproject.com/en/5.1/topics/testing/overview/#running-tests)
- [Testing tools](https://docs.djangoproject.com/en/5.1/topics/testing/tools/)

run tests for the app `myapp`:

```bash
python manage.py test myapp
```

run all the tests of the django project:

```bash
python manage.py test
```

run all test tests in the `animals.tests` module:

```bash
python manage.py test animals.tests
```

run just one test method:

```bash
python manage.py test animals.test.AnimalTestCase.test_animals_can_speak
```

run tests for files that match a specific pattern:

```bash
./manage.py test --pattern="tests_*.py"
```

Django provides a test `client` to simulate a user interacting with the code at
the view level. It can be used in test files and also in the `shell`.

```python
from django.test import Client
client = Client()

client.get("/polls/results")
```

```python
from django.test.utils import setup_test_environment
```

__Note__: `setup_test_environment` installs a template renderer which allows
one to examine additional attributes on responses. Especially
`response.context` which is the context dictionnary used in the template.

## Static Files

The `staticfiles` app collects static files from each application into a single
location that can easily be served in production.

create a `static` directory in `myapp`: `myapp/static/myapp/`.
one can serve anything from stylesheets to images.

Documentation for managing static files in Django
[here](https://docs.djangoproject.com/en/5.1/howto/static-files/).

## Third Party Packages

Third party packages that integrate with Django need some post installation
setup to integrate them into the project. Often, it is required to add the
package to the list of `INSTALLED_APPS` setting. Some packages may need other
changes like additions to the URLconf.

## Celery

Celery is a __distributed task queue__ for UNIX systems.
Django generally integrates with Celery by offloading time intensive tasks to
Celery. The web app can continue to respond quickly while the task is performed
in the background.

To receive tasks from a program and send results to a backend, a __message
broker__ is required for communication. __Redis__ and __RabbitMQ__ are two
message brokers that are often used with Celery.

Main use cases:

- __Offloading work__ from the app to distributed processes. Eg. email sending,
image processing, text processing, data analysis, ML inference, report
generation, etc.
- __Scheduling task execution at a specific time__, sometimes as recurring
events.

The protocol used by celery is called __AMQP__: Advanced Message Queuing
Protocol.
Redis and RabbitMQ can communicate with this protocol.

### Database Backend

Django config to setup the database backend:

```python
CELERY_BROKER_URL = "redis://localhost:6379"
# CELERY_BROKER_URL = "amqp://myuser:mypassword@localhost:5672/myvhost"
CELERY_RESULT_BACKEND = "redis://localhost:6379"
```

### Celery Workers

worker processes that run tasks independently from one another and outside of
the context of the main service.

start a celery worker using the `django_celery` app:

```bash
python -m celery -A django_celery worker
```

__Note__: One needs to set up a celery app in the Django project to make it
work.

Add a `celery.py` module in the project. This is where the celery tasks are
defined and configured.

### Tasks

Handing a task to Celery revolves around creating functions decorated with `@shared_task`:

```python
# feedback/tasks.py
from time import sleep

from celery import shared_task
from django.core.mail import send_mail


@shared_task
def send_feedback_email_task(email_address: str, message: str) -> None:
    """Send an email when the feedback form has been submitted."""
    sleep(20)  # Simulate expensive operations that freeze Django
    send_mail(
        subject="Your Feedback",
        message=f"\t{message}\n\nThank you!",
        from_email="support@example.com",
        recipient_list=[email_address],
        fail_silently=False,
    )
```

Then calling the task from the django codebase - using `delay` or `apply_async`:

```python
send_feedback_email_task.delay(
    self.cleaned_data["email"],
    self.cleaned_data["message"],
)

send_feedback_email_task.apply_async(args=[
        self.cleaned_data["email"],
        self.cleaned_data["message"],
    ]
)
```

- `delay`: provides a shortcut to apply_sync without many configuration options
- `apply_async`: many execution options like `retry`, `countdown`, etc,

__Note__: Celery workers need to be restarted as it loads the code in memory.
Some autoreloading options are available.

The Celery process outputs some logs about the task handling.

### Celery Beat

A scheduler that orchestrates when to run tasks. Can be used to schedule
periodic tasks as well. It adds a time based scheduler for Celery workers.

To configure a celery beat, set the following in the `settings.py` project
file:

```python
CELERY_BEAT_SCHEDULE = {
    "sample_task": {
        "task": "core.tasks.sample_task",
        "schedule": crontab(minute="*/1"),
    },
    "send_email_report": {
        "task": "core.tasks.send_email_report",
        "schedule": crontab(hour="*/1"),
    },
}
```

Below is the definition of the tasks:

```python
from celery import shared_task
from celery.utils.log import get_task_logger
from django.core.management import call_command

logger = get_task_logger(__name__)

@shared_task
def sample_task():
    logger.info("The sample task just ran.")


@shared_task
def send_email_report():
    # Possible to call a django management command from a Celery task
    call_command("email_report", )
```

### Monitoring Celery

Celery tasks can be monitored with [Flower](https://flower.readthedocs.io/en/latest/).

### Celery Task Types

- __QueueOnce__: Ensuring that a task is only executed once, even if it is triggered multiple times.

### Documentation

- [Using Celery with Django](https://docs.celeryq.dev/en/stable/django/first-steps-with-django.html#using-celery-with-django)
- [Django Celery Periodic Tasks](https://testdriven.io/blog/django-celery-periodic-tasks/)
- [Django + Celery Series](https://testdriven.io/blog/django-and-celery/#flower-dashboard)
- [Working with Celery and Django Database Transactions](https://testdriven.io/blog/celery-database-transactions/)
- [Automatically Retrying failed Celery tasks](https://testdriven.io/blog/retrying-failed-celery-tasks/)

## Django Rest Framework - DRF

### Serializers

Serializers help serizalizing and deserializing model instances into
representations such as json. They work similarly to Django's forms.

The `ModelSerializer` provide shortcuts for creating serializers based on a
Model class. They provide default implementations for the `create` and `save`
methods.

serialize an object:

```python
serializer = SnippetSerializer(snippet)
serializer.data
# {'id': 2, 'title': '', 'code': 'print("hello, world")\n', 'linenos': False, 'language': 'python', 'style': 'friendly'}
```

serialize the data as json:

```python
content = JSONRenderer().render(serializer.data)
```

deserialization

```python
import io

stream = io.BytesIO(content)
data = JSONParser().parse(stream)

serializer = SnippetSerializer(data=data)
serializer.validated_data

# Can also save the object
serializer.save()
```

serialize a queryset:

```python
serializer = SnippetSerializer(Snippet.objects.all(), many=True)
```

inspect the representation of a serializer:

```python
from snippets.serializers import SnippetSerializer
serializer = SnippetSerializer()
print(repr(serializer))
# SnippetSerializer():
#    id = IntegerField(label='ID', read_only=True)
#    title = CharField(allow_blank=True, max_length=100, required=False)
#    code = CharField(style={'base_template': 'textarea.html'})
#    linenos = BooleanField(required=False)
#    language = ChoiceField(choices=[('Clipper', 'FoxPro'), ('Cucumber', 'Gherkin'), ('RobotFramework', 'RobotFramework'), ('abap', 'ABAP'), ('ada', 'Ada')...
#    style = ChoiceField(choices=[('autumn', 'autumn'), ('borland', 'borland'), ('bw', 'bw'), ('colorful', 'colorful')...
```

readonly fields can be added so that they cannot be updated. Useful when having model relationships

```python
owner = serializers.ReadOnlyField(source='owner.username')
```

### DRF Requests

DRF introduces a `Request` object that extends the `HttpRequest` and provides
more flexible request parsing.

#### Parsing

`request.data` instead of `request.POST`
`request.get_query_params` instead of `request.GET`

### DRF Response

DRF introduces a `Response` object which extends `TemplateResponse` that takes
unrendered content and uses content negotation to determine the correct content
type to return to the client.

### DRF Views

DRF provides two wrappers to write API views:

- `@api_view` decorator for working with function based views.
- `APIView` class for working with class-based views.

#### Function based view

```python
@api_view(['GET', 'PUT', 'DELETE'])
def snippet_detail(request, pk):
    """
    Retrieve, update or delete a code snippet.
    """
    try:
        snippet = Snippet.objects.get(pk=pk)
    except Snippet.DoesNotExist:
        return Response(status=status.HTTP_404_NOT_FOUND)

    if request.method == 'GET':
        serializer = SnippetSerializer(snippet)
        return Response(serializer.data)

    elif request.method == 'PUT':
        serializer = SnippetSerializer(snippet, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    elif request.method == 'DELETE':
        snippet.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)
```

#### Class based view

##### Class based view bare

The `APIView` class can be subtyped to implement the different HTTP methods
(get, post, put, ...). Fetching the objects and returning the HTTP codes have
to be done manually.

```python
class SnippetDetail(APIView):
    """
    Retrieve, update or delete a snippet instance.
    """
    def get_object(self, pk):
        try:
            return Snippet.objects.get(pk=pk)
        except Snippet.DoesNotExist:
            raise Http404

    def get(self, request, pk, format=None):
        snippet = self.get_object(pk)
        serializer = SnippetSerializer(snippet)
        return Response(serializer.data)

    def put(self, request, pk, format=None):
        snippet = self.get_object(pk)
        serializer = SnippetSerializer(snippet, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def delete(self, request, pk, format=None):
        snippet = self.get_object(pk)
        snippet.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)

```

##### Class based view with Mixins

Mixins are available to abstract common operations (retrieve, update, destroy)
on model objects. The HTTP status codes do not need to be explicited but a
queryset and a serializer_class needs to be declared.

```python
class SnippetDetail(mixins.RetrieveModelMixin,
                    mixins.UpdateModelMixin,
                    mixins.DestroyModelMixin,
                    generics.GenericAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer

    def get(self, request, *args, **kwargs):
        return self.retrieve(request, *args, **kwargs)

    def put(self, request, *args, **kwargs):
        return self.update(request, *args, **kwargs)

    def delete(self, request, *args, **kwargs):
        return self.destroy(request, *args, **kwargs)
```

One can go even more generic by using generic class based views like so:

```python
class SnippetList(generics.ListCreateAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer


class SnippetDetail(generics.RetrieveUpdateDestroyAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer
```

the `perform_create` method can be added to override how the instance save is managed.

```python
class SnippetList(generics.ListCreateAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer

    def perform_create(self, serializer):
        serializer.save(owner=self.request.user)
```

### DRF Authentication

REST framework provides several authentication schemes out of the box, and also
allows you to implement custom schemes.
Authentication always runs at the very start of the view, before the permission
and throttling checks occur, and before any other code is allowed to proceed.

- The `request.user` property will typically be set to an instance of the
contrib.auth package's User class.
- The `request.auth` property is used for any additional authentication
information, for example, it may be used to represent an authentication token
that the request was signed with.

adding login to the Browsable API

```python
urlpatterns += [
    path('api-auth/', include('rest_framework.urls')),
]
```

all the authentication methods are listed [here](https://www.django-rest-framework.org/api-guide/authentication/)

setting the authentication scheme in `setttings.py` for applying globally across all views

```python
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.BasicAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ]
}
```

setting the authentication mechanism at the view level

```python
from rest_framework.authentication import SessionAuthentication, BasicAuthentication

# class based
class ExampleView(APIView):
    ...
    authentication_classes = [SessionAuthentication, BasicAuthentication]
    ...

# function based
@api_view(['GET'])
@authentication_classes([SessionAuthentication, BasicAuthentication])
@permission_classes([IsAuthenticated])
def example_view(request, format=None):
    content = {
        'user': str(request.user),  # `django.contrib.auth.User` instance.
        'auth': str(request.auth),  # None
    }
    return Response(content)
```

#### HTTP status codes

When an unauthenticated request is denied permission, there are two different
error codes that may be appropriate:

- HTTP 401 Unauthorized
- HTTP 403 Permission Denied

- [Basic Authentication](https://www.django-rest-framework.org/api-guide/authentication/#basicauthentication)
- [TokenAuthentication](https://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication)
- [SessionAuthentication](https://www.django-rest-framework.org/api-guide/authentication/#sessionauthentication)
- [JWTAuthentication](https://www.django-rest-framework.org/api-guide/authentication/#json-web-token-authentication)
- [Custom Authentication](https://www.django-rest-framework.org/api-guide/authentication/#custom-authentication)

### DRF Permissions

#### View Level permissions

permissions can be added to views.

```python
from rest_framework import permissions

class SnippetList(generics.ListCreateAPIView):
    ...
    permission_classes = [permissions.IsAuthenticatedOrReadOnly]
```

#### Object Level permissions

custom permissions can be created to add to views:

```python
# permissions.py
from rest_framework import permissions


class IsOwnerOrReadOnly(permissions.BasePermission):
    """
    Custom permission to only allow owners of an object to edit it.
    """

    def has_object_permission(self, request, view, obj):
        # Read permissions are allowed to any request,
        # so we'll always allow GET, HEAD or OPTIONS requests.
        if request.method in permissions.SAFE_METHODS:
            return True

        # Write permissions are only allowed to the owner of the snippet.
        return obj.owner == request.user
```

```python
# views.py
from rest_framework import permissions
from snippets.permissions import IsOwnerOrReadOnly

class SnippetList(generics.ListCreateAPIView):
    ...
    permission_classes = [permissions.IsAuthenticatedOrReadOnly,
                          IsOwnerOrReadOnly]
```

#### CLI testing

make a successful request by including the username and password of one of the
users we created (if basic authentication is enabled)

```bash
http -a admin:password123 POST http://127.0.0.1:8000/snippets/ code="print(789)"
```

### Relationships and Hyperlinked APIs

A way to improve the cohesion and discoverability of the API, by using
hyperlinking for relationships.

#### Hyperlinking an API

Many different choices to represent a relationship between two entities:

- Using primary keys.
- Using hyperlinking between entities.
- Using a unique identifying slug field on the related entity.
- Using the default string representation of the related entity.
- Nesting the related entity inside the parent representation.
- Some other custom representation.

REST framework supports all of these styles.

### ViewSets

DRF provides an abstraction to deal with views and automate the url
configuration to follow consistent route naming conventions: the `ViewSet`
class.

They provide a similar API as `View` classes except that they provide methods
such as `retrieve` or `update` (but no method like `get` or `post`).

The `ReadOnlyModelViewSet` provides the default read-only operations

```python
from rest_framework import viewsets


class UserViewSet(viewsets.ReadOnlyModelViewSet):
    """
    This viewset automatically provides `list` and `retrieve` actions.
    """
    queryset = User.objects.all()
    serializer_class = UserSerializer
```

add an extra handler with the decorator `@action`

```python
class SnippetViewSet(viewsets.ModelViewSet):
    """
    This ViewSet automatically provides `list`, `create`, `retrieve`,
    `update` and `destroy` actions.

    Additionally we also provide an extra `highlight` action.
    """
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer
    permission_classes = [permissions.IsAuthenticatedOrReadOnly,
                          IsOwnerOrReadOnly]

    @action(detail=True, renderer_classes=[renderers.StaticHTMLRenderer])
    def highlight(self, request, *args, **kwargs):
        snippet = self.get_object()
        return Response(snippet.highlighted)
```

#### Manual URL binding

binding URLs to ViewSets can be done manually like so:

```python
# urls.py
snippet_list = SnippetViewSet.as_view({
    'get': 'list',
    'post': 'create'
})
snippet_detail = SnippetViewSet.as_view({
    'get': 'retrieve',
    'put': 'update',
    'patch': 'partial_update',
    'delete': 'destroy'
})
...
urlpatterns = format_suffix_patterns([
    ...
    path('snippets/', snippet_list, name='snippet-list'),
    path('snippets/<int:pk>/', snippet_detail, name='snippet-detail'),
    ...
])
```

#### Automatic URL binding

routers can be used to automatically bind urls to viewsets.

```python
from rest_framework.routers import DefaultRouter

from snippets import views

# Create a router and register our ViewSets with it.
router = DefaultRouter()
router.register(r'snippets', views.SnippetViewSet, basename='snippet')
router.register(r'users', views.UserViewSet, basename='user')

# The API URLs are now determined automatically by the router.
urlpatterns = [
    path('', include(router.urls)),
]
```

### DRF Resources

- [Official Tutorials](https://www.django-rest-framework.org/tutorial/1-serialization/)
- [DRF API guide](https://www.django-rest-framework.org/api-guide/requests/)

## Resources

- [Official Tutorials](https://docs.djangoproject.com/en/5.1/intro/tutorial01/)
- [Django Documentation](https://docs.djangoproject.com/en/5.1/genindex/)
- [Using Django - Tutorials by topics](https://docs.djangoproject.com/en/5.1/topics/)
  - [Performance and Optimization](https://docs.djangoproject.com/en/5.1/topics/performance/)
  - [Cache framework](https://docs.djangoproject.com/en/5.1/topics/cache/)
  - [User authentication](https://docs.djangoproject.com/en/5.1/topics/auth/)
  - [Managing files](https://docs.djangoproject.com/en/5.1/topics/files/)
  - [DB Migrations](https://docs.djangoproject.com/en/5.1/topics/migrations/)
  - [Working with forms](https://docs.djangoproject.com/en/5.1/topics/forms/)
  - [Handling HTTP requests](https://docs.djangoproject.com/en/5.1/topics/http/)
  - [Models and databases](https://docs.djangoproject.com/en/5.1/topics/db/)
- [How to guides](https://docs.djangoproject.com/en/5.1/howto/)
  - [How to create a django admin command](https://docs.djangoproject.com/en/5.1/howto/custom-management-commands/)
  - [How to upgrade Django to a newer version](https://docs.djangoproject.com/en/5.1/howto/upgrade-version/)
  - [How to provide initial data for models](https://docs.djangoproject.com/en/5.1/howto/initial-data/)
  - [How to override templates](https://docs.djangoproject.com/en/5.1/howto/overriding-templates/)
- [RealPython: Asynchronous Tasks with Celery and Django](https://realpython.com/asynchronous-tasks-with-django-and-celery/)
- [Understanding Django - Matt Layman](https://www.mattlayman.com/understand-django/)
